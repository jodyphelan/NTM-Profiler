import sys
import argparse
import ntm_profiler as ntmp
import os

def main_speciate(args):
    if args.external_db:
        conf = ntmp.get_conf_dict_with_path(args.external_db)
    else:
        if args.db=="ntm_db" and not os.path.isfile(f"{sys.base_prefix}/share/ntm_profiler/ntm_db.kmers.txt"):
            ntmp.run_cmd("ntm-profiler update_db")
        conf = ntmp.get_conf_dict(args.db)

    results = {"sample_name":args.prefix}
    results["species"] = ntmp.check_for_kmers(conf["kmers"],args.read1)
    outfile = "%s.species.txt" % args.prefix
    ntmp.write_speciation_results(results,outfile)
    

def main_collate(args):
    ntmp.collate_results(args.outfile,args.samples,args.dir)


def main_update_db(args):
    import urllib.request
    if ntmp.nofolder(sys.base_prefix+"/share/ntm_profiler"):
        ntmp.run_cmd("mkdir %s " % (sys.base_prefix+"/share/ntm_profiler/"))
    urllib.request.urlretrieve("https://raw.githubusercontent.com/jodyphelan/NTM-Profiler/main/db/ntm_db.kmers.txt",f"{sys.base_prefix}/share/ntm_profiler/ntm_db.kmers.txt")

#### Argument Parsing ####

parser = argparse.ArgumentParser(description='NTM-Profiler pipeline',formatter_class=argparse.ArgumentDefaultsHelpFormatter)
parser.add_argument('--version', action='version', version="NTM-Profiler version %s" % ntmp._VERSION)
subparsers = parser.add_subparsers(help="Task to perform")

# Profile #
parser_sub = subparsers.add_parser('speciate', help='Run whole profiling pipeline', formatter_class=argparse.ArgumentDefaultsHelpFormatter)
input=parser_sub.add_argument_group("Input options")
group = input.add_mutually_exclusive_group(required=True)
group.add_argument('--read1','-1',help='First read file')
input.add_argument('--read2','-2',help='Second read file')

input.add_argument('--db',default='ntm_db',help='Mutation panel name')
input.add_argument('--external_db',type=str,help='Path to db files prefix (overrides "--db" parameter)')

output=parser_sub.add_argument_group("Output options")

output.add_argument('--prefix','-p',default="ntm-profiler",help='Sample prefix for all results generated')
parser_sub.add_argument('--version', action='version', version="NTM-Profiler version %s" % ntmp._VERSION)
parser_sub.set_defaults(func=main_speciate)


# Collate results #
parser_sub = subparsers.add_parser('collate', help='Collate results form multiple samples together', formatter_class=argparse.ArgumentDefaultsHelpFormatter)
parser_sub.add_argument('--outfile','-o',help='Output file name',required = True)
parser_sub.add_argument('--samples',help='File with samples (one per line)')
parser_sub.add_argument('--dir','-d',default=".",help='Storage directory')
parser_sub.add_argument('--version', action='version', version="NTM-Profiler version %s" % ntmp._VERSION)
parser_sub.set_defaults(func=main_collate)

# Update database #
parser_sub = subparsers.add_parser('update_db', help='Collate results form multiple samples together', formatter_class=argparse.ArgumentDefaultsHelpFormatter)
parser_sub.add_argument('--version', action='version', version="NTM-Profiler version %s" % ntmp._VERSION)
parser_sub.set_defaults(func=main_update_db)




args = parser.parse_args()
if vars(args)=={}:
    parser.print_help(sys.stderr)
else:
    args.func(args)